"use strict";(()=>{var e={};e.id=911,e.ids=[911],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},6024:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>v,staticGenerationAsyncStorage:()=>_});var s={};r.r(s),r.d(s,{POST:()=>f});var i=r(3036),a=r(5736),n=r(5262),o=r(942),c=r(8239);let l={free:{name:"Free",description:"Essential cognitive frameworks for beginners",percentAccess:10,monthlyPrice:0,annualPrice:0,features:["10% din librăria completă","Acces la framework-uri de bază","Community access","Email support"],stripeMonthlyId:null,stripeAnnualId:null},architect:{name:"Arhitect",description:"Advanced frameworks with premium templates",percentAccess:40,monthlyPrice:2900,annualPrice:29e3,features:["40% din librăria completă","200+ framework-uri avansate","Interactive templates","Priority community access","Video tutorials","Advanced search & filters"],stripeMonthlyId:"price_architect_monthly",stripeAnnualId:"price_architect_annual"},initiate:{name:"Inițiat",description:"Professional-grade content and priority support",percentAccess:70,monthlyPrice:4700,annualPrice:47e3,features:["70% din librăria completă","500+ framework-uri profesionale","Custom template builder","VIP community access","Live workshops","Priority support","Framework analytics"],stripeMonthlyId:"price_initiate_monthly",stripeAnnualId:"price_initiate_annual"},elite:{name:"Elite",description:"Complete access with exclusive frameworks",percentAccess:100,monthlyPrice:7400,annualPrice:74e3,features:["100% din librăria completă","Framework-uri exclusive Elite","Personal AI Assistant","1-on-1 consultation sessions","Custom framework development","White-label solutions","API access complet"],stripeMonthlyId:"price_elite_monthly",stripeAnnualId:"price_elite_annual"}};var u=r(6981),m=r(2866),p=r(3516),d=r(5253);let f=(0,m.er)(m.rk.checkout,e=>{let t=e.headers.get("x-forwarded-for"),r=t?t.split(",")[0]:"unknown";return`stripe_checkout:${r}`})(async e=>{let t=Date.now();try{let r=e.headers.get("content-type");if(!r||!r.includes("application/json"))return(0,d.DL)("Invalid content type in Stripe request",{contentType:r}),o.NextResponse.json({error:"Content-Type must be application/json"},{status:400});let s=await e.json(),i=(0,p.rI)(p.TD,s);if(!i.success){let e=i.errors;return(0,d.DL)("Invalid Stripe checkout data",{errors:e,dataKeys:Object.keys(s)}),o.NextResponse.json({error:"Invalid checkout data",details:e},{status:400})}let{tier:a,userId:n}=i.data;if(!l[a])return(0,d.DL)("Invalid tier in Stripe request",{tier:a,userId:n}),o.NextResponse.json({error:"Invalid tier"},{status:400});let m=(function(){let e=Object.entries({NEXT_PUBLIC_SUPABASE_URL:process.env.NEXT_PUBLIC_SUPABASE_URL,SUPABASE_SERVICE_ROLE_KEY:process.env.SUPABASE_SERVICE_ROLE_KEY,NEXT_PUBLIC_SITE_URL:process.env.NEXT_PUBLIC_SITE_URL}).filter(([,e])=>!e).map(([e])=>e);if(e.length>0)throw Error(`Missing required environment variables: ${e.join(", ")}`);try{new URL(process.env.NEXT_PUBLIC_SUPABASE_URL),new URL(process.env.NEXT_PUBLIC_SITE_URL)}catch{throw Error("Invalid URL format in environment variables")}if(!process.env.SUPABASE_SERVICE_ROLE_KEY.startsWith("eyJ"))throw Error("Invalid SUPABASE_SERVICE_ROLE_KEY format")}(),(0,u.eI)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1,detectSessionInUrl:!1}})),{data:f,error:h}=await m.auth.admin.getUserById(n);if(h||!f)return(0,d.DL)("User not found in Stripe request",{userId:n,error:h?.message}),o.NextResponse.json({error:"User not found"},{status:404});(0,d.DL)("Stripe checkout attempt",{userId:n,tier:a,email:f.user.email?.substring(0,3)+"***@"+f.user.email?.split("@")[1],ip:e.headers.get("x-forwarded-for")?.split(",")[0]||e.headers.get("x-real-ip")||"unknown"});let g=l[a],_=await c.Ag.checkout.sessions.create({payment_method_types:["card"],line_items:[{price_data:{currency:"eur",product_data:{name:`AI-Prompt-Templates ${g.name} Tier`,description:g.description,images:["https://ai-prompt-templates.com/logo.png"]},unit_amount:g.monthlyPrice},quantity:1}],mode:"payment",success_url:`${process.env.NEXT_PUBLIC_SITE_URL}/dashboard?success=true&tier=${a}`,cancel_url:`${process.env.NEXT_PUBLIC_SITE_URL}/pricing?canceled=true`,customer_email:f.user.email,metadata:{userId:n,tier:a,type:"tier_upgrade",timestamp:new Date().toISOString(),ip:e.headers.get("x-forwarded-for")?.split(",")[0]||e.headers.get("x-real-ip")||"unknown"}}),v=Date.now()-t;return d.kg.performance("POST /api/stripe/create-checkout-session",v,{sessionId:_.id,tier:a,userId:n}),o.NextResponse.json({sessionId:_.id,url:_.url})}catch(r){let e=Date.now()-t;return(0,d.H)("Stripe checkout session creation error",{duration:e,error:r instanceof Error?r.message:"Unknown error",stack:r instanceof Error?r.stack:void 0}),o.NextResponse.json({error:"Internal server error"},{status:500})}}),h=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stripe/create-checkout-session/route",pathname:"/api/stripe/create-checkout-session",filename:"route",bundlePath:"app/api/stripe/create-checkout-session/route"},resolvedPagePath:"/Users/vadimcusnir/GitRepo/ai-prompt-templates/packages/ai-prompt-templates/app/api/stripe/create-checkout-session/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:v}=h,x="/api/stripe/create-checkout-session/route";function y(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:_})}},5253:(e,t,r)=>{var s;r.d(t,{DL:()=>o,H:()=>n,kg:()=>a}),function(e){e.ERROR="error",e.WARN="warn",e.INFO="info",e.DEBUG="debug"}(s||(s={}));class i{shouldLog(e){return!!this.isDevelopment||!this.isProduction||"error"===e||"warn"===e}formatMessage(e){let t=e.timestamp,r=e.level.toUpperCase(),s=e.message,i=e.context?` | Context: ${JSON.stringify(e.context)}`:"",a=e.error?` | Error: ${e.error.message}`:"";return`[${t}] ${r}: ${s}${i}${a}`}addToBuffer(e){this.logBuffer.push(e),this.logBuffer.length>this.maxBufferSize&&this.logBuffer.shift()}async sendToExternalService(e){if(this.isProduction&&"error"===e.level)try{await fetch("/api/logs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(e){console.error("Failed to send log to external service:",e)}}error(e,t,r){let s={level:"error",message:e,timestamp:new Date().toISOString(),context:t,error:r};this.addToBuffer(s),this.shouldLog("error")&&console.error(this.formatMessage(s)),this.sendToExternalService(s)}warn(e,t){let r={level:"warn",message:e,timestamp:new Date().toISOString(),context:t};this.addToBuffer(r),this.shouldLog("warn")&&console.warn(this.formatMessage(r))}info(e,t){let r={level:"info",message:e,timestamp:new Date().toISOString(),context:t};this.addToBuffer(r),this.shouldLog("info")&&console.info(this.formatMessage(r))}debug(e,t){let r={level:"debug",message:e,timestamp:new Date().toISOString(),context:t};this.addToBuffer(r),this.shouldLog("debug")&&console.debug(this.formatMessage(r))}security(e,t){let r={level:"warn",message:`SECURITY: ${e}`,timestamp:new Date().toISOString(),context:t};this.addToBuffer(r),console.warn(this.formatMessage(r)),this.sendToExternalService(r)}performance(e,t,r){let s={level:"info",message:`PERFORMANCE: ${e} took ${t}ms`,timestamp:new Date().toISOString(),context:r};this.addToBuffer(s),this.shouldLog("info")&&console.info(this.formatMessage(s))}getLogs(e){return e?this.logBuffer.filter(t=>t.level===e):[...this.logBuffer]}clearLogs(){this.logBuffer=[]}exportLogs(){return this.logBuffer.map(e=>this.formatMessage(e)).join("\n")}constructor(){this.isDevelopment=!1,this.isProduction=!0,this.logBuffer=[],this.maxBufferSize=100}}let a=new i,n=(e,t,r)=>a.error(e,t,r),o=(e,t)=>a.security(e,t)},2866:(e,t,r)=>{r.d(t,{er:()=>n,rk:()=>a});let s=new Map;async function i(e,t){let r=Date.now();t.windowMs;let i=s.get(e);return!i||i.resetTime<r?(s.set(e,{count:1,resetTime:r+t.windowMs}),{success:!0,remaining:t.max-1,resetTime:r+t.windowMs}):i.count>=t.max?{success:!1,remaining:0,resetTime:i.resetTime,message:t.message}:(i.count++,s.set(e,i),{success:!0,remaining:t.max-i.count,resetTime:i.resetTime})}setInterval(()=>{let e=Date.now();for(let[t,r]of s.entries())r.resetTime<e&&s.delete(t)},36e5);let a={auth:{windowMs:9e5,max:5,message:"Too many authentication attempts, please try again later",standardHeaders:!0,legacyHeaders:!1},api:{windowMs:6e4,max:100,message:"Too many requests, please try again later",standardHeaders:!0,legacyHeaders:!1},checkout:{windowMs:6e4,max:3,message:"Too many checkout attempts, please try again later",standardHeaders:!0,legacyHeaders:!1}};function n(e,t){return function(r){return async function(s,...a){let n=t(s),o=await i(n,e);return o.success?r(s,...a):new Response(JSON.stringify({error:o.message}),{status:429,headers:{"Content-Type":"application/json"}})}}}},8239:(e,t,r)=>{r.d(t,{Ag:()=>i});var s=r(1214);if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not defined in environment variables");let i=new s.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-07-30.basil",typescript:!0});process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY||process.env.STRIPE_PUBLISHABLE_KEY,process.env.STRIPE_WEBHOOK_SECRET},3516:(e,t,r)=>{r.d(t,{DH:()=>o,Hi:()=>l,Pp:()=>a,TD:()=>c,i$:()=>n,rI:()=>u,z6:()=>m});var s=r(1309),i=r(9693);let a=s.Ry({title:s.Z_().min(1,"Title is required").max(200,"Title must be less than 200 characters").regex(/^[a-zA-Z0-9\s\-_.,!?()]+$/,"Title contains invalid characters"),cognitive_category:s.Km(["deep_analysis","meaning_engineering","cognitive_frameworks","consciousness_mapping","advanced_systems"]),difficulty_tier:s.Km(["foundation","advanced","expert","architect"]),preview_content:s.Z_().min(10,"Preview content must be at least 10 characters").max(1e3,"Preview content must be less than 1000 characters").refine(e=>!e.includes("<script"),"Preview content contains invalid HTML"),full_content:s.Z_().min(50,"Full content must be at least 50 characters").max(5e4,"Full content must be less than 50000 characters").refine(e=>!e.includes("<script"),"Full content contains invalid HTML"),cognitive_depth_score:s.Rx().int("Cognitive depth score must be an integer").min(1,"Cognitive depth score must be at least 1").max(10,"Cognitive depth score must be at most 10"),pattern_complexity:s.Rx().int("Pattern complexity must be an integer").min(1,"Pattern complexity must be at least 1").max(5,"Pattern complexity must be at most 5"),base_price_cents:s.Rx().int("Price must be an integer").min(100,"Price must be at least 100 cents (€1)").max(1e5,"Price must be at most 100000 cents (€1000)"),meaning_layers:s.IX(s.Z_()).min(1,"At least one meaning layer is required").max(10,"Maximum 10 meaning layers allowed").refine(e=>e.every(e=>e.length>=3&&e.length<=500&&!e.includes("<script")),"Meaning layers contain invalid content"),anti_surface_features:s.IX(s.Z_()).min(1,"At least one anti-surface feature is required").max(10,"Maximum 10 anti-surface features allowed").refine(e=>e.every(e=>e.length>=3&&e.length<=500&&!e.includes("<script")),"Anti-surface features contain invalid content"),required_tier:s.Km(["explorer","architect","initiate","master"]).default("explorer"),is_published:s.O7().default(!1),quality_score:s.Rx().int("Quality score must be an integer").min(1,"Quality score must be at least 1").max(10,"Quality score must be at most 10").default(5),meta_tags:s.IX(s.Z_()).max(20,"Maximum 20 meta tags allowed").default([]),keywords:s.IX(s.Z_()).max(50,"Maximum 50 keywords allowed").default([])}),n=a.partial().extend({id:s.Z_().uuid("Invalid prompt ID format"),updated_at:s.Z_().datetime().optional()}),o=s.Ry({email:s.Z_().email("Invalid email format").min(5,"Email too short").max(254,"Email too long"),password:s.Z_().min(8,"Password must be at least 8 characters").max(128,"Password too long").regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,"Password must contain lowercase, uppercase and number"),action:s.Km(["signin","signup"])}),c=s.Ry({tier:s.Km(["explorer","architect","initiate","master"]),userId:s.Z_().uuid("Invalid user ID format")}),l=s.Ry({search:s.Z_().max(100,"Search query too long").optional(),category:s.Km(["deep_analysis","meaning_engineering","cognitive_frameworks","consciousness_mapping","advanced_systems"]).optional(),tier:s.Km(["explorer","architect","initiate","master"]).default("explorer"),difficulty:s.Km(["foundation","advanced","expert","architect"]).optional(),minPrice:s.Rx().int().min(0).optional(),maxPrice:s.Rx().int().min(0).optional(),minScore:s.Rx().int().min(1).max(10).optional(),maxScore:s.Rx().int().min(1).max(10).optional()});function u(e,t){try{let r=e.parse(t);return{success:!0,data:r}}catch(e){if(e instanceof i.jm)return{success:!1,errors:e.issues.map(e=>`${e.path.join(".")}: ${e.message}`)};return{success:!1,errors:["Validation failed"]}}}function m(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[522,753,309,214],()=>r(6024));module.exports=s})();