"use strict";(()=>{var e={};e.id=567,e.ids=[567],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},4794:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>v,requestAsyncStorage:()=>w,routeModule:()=>h,serverHooks:()=>y,staticGenerationAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{GET:()=>g,POST:()=>m});var a=r(3036),o=r(5736),i=r(5262),n=r(942),l=r(817),c=r(9362),u=r(5253);async function m(e){try{let t=(0,l.createRouteHandlerClient)({cookies:c.cookies}),{data:{session:r}}=await t.auth.getSession(),{type:s,data:a,timestamp:o,sessionId:i}=await e.json();if(!s||!a||!Array.isArray(a))return n.NextResponse.json({error:"Invalid request format"},{status:400});let m=e.ip||e.headers.get("x-forwarded-for")||"unknown",g=`analytics:${m}:${s}`,{data:h}=await t.from("rate_limits").select("count, reset_time").eq("key",g).single(),w=Date.now();if(h){if(w<h.reset_time&&h.count>=100)return n.NextResponse.json({error:"Rate limit exceeded"},{status:429});w>=h.reset_time?await t.from("rate_limits").upsert({key:g,count:1,reset_time:w+6e4}):await t.from("rate_limits").update({count:h.count+1}).eq("key",g)}else await t.from("rate_limits").insert({key:g,count:1,reset_time:w+6e4});switch(s){case"events":await p(a,r?.user?.id,i);break;case"performance":await d(a,r?.user?.id,i);break;case"errors":await f(a,r?.user?.id,i);break;default:return n.NextResponse.json({error:"Unknown analytics type"},{status:400})}return u.kg.info("Analytics data collected",{type:s,count:a.length,userId:r?.user?.id,sessionId:i,clientIp:m}),n.NextResponse.json({success:!0,processed:a.length})}catch(e){return u.kg.error("Analytics API error",{error:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function p(e,t,r){let s=(0,l.createRouteHandlerClient)({cookies:c.cookies}),a=e.map(e=>({event_name:e.name,properties:e.properties||{},timestamp:new Date(e.timestamp||Date.now()).toISOString(),user_id:t,session_id:r,page:e.page,user_agent:e.userAgent,referrer:e.referrer,created_at:new Date().toISOString()}));for(let e=0;e<a.length;e+=100){let t=a.slice(e,e+100),{error:r}=await s.from("analytics_events").insert(t);r&&u.kg.error("Failed to insert analytics events",{error:r.message})}}async function d(e,t,r){let s=(0,l.createRouteHandlerClient)({cookies:c.cookies}),a=e.map(e=>({metric_name:e.name,value:e.value,unit:e.unit,metadata:e.metadata||{},timestamp:new Date(e.timestamp||Date.now()).toISOString(),user_id:t,session_id:r,created_at:new Date().toISOString()}));for(let e=0;e<a.length;e+=100){let t=a.slice(e,e+100),{error:r}=await s.from("analytics_performance").insert(t);r&&u.kg.error("Failed to insert performance metrics",{error:r.message})}}async function f(e,t,r){let s=(0,l.createRouteHandlerClient)({cookies:c.cookies}),a=e.map(e=>({error_message:e.message,stack_trace:e.stack,component:e.component,metadata:e.metadata||{},timestamp:new Date(e.timestamp||Date.now()).toISOString(),user_id:t,session_id:r,created_at:new Date().toISOString()}));for(let e=0;e<a.length;e+=100){let t=a.slice(e,e+100),{error:r}=await s.from("analytics_errors").insert(t);r&&u.kg.error("Failed to insert error logs",{error:r.message})}}async function g(){return n.NextResponse.json({status:"healthy",timestamp:new Date().toISOString(),service:"analytics-api"})}let h=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/analytics/route",pathname:"/api/analytics",filename:"route",bundlePath:"app/api/analytics/route"},resolvedPagePath:"/Users/vadimcusnir/GitRepo/ai-prompt-templates/packages/ai-prompt-templates/app/api/analytics/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:x,serverHooks:y}=h,S="/api/analytics/route";function v(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:x})}},5253:(e,t,r)=>{var s;r.d(t,{DL:()=>n,H:()=>i,kg:()=>o}),function(e){e.ERROR="error",e.WARN="warn",e.INFO="info",e.DEBUG="debug"}(s||(s={}));class a{shouldLog(e){return!!this.isDevelopment||!this.isProduction||"error"===e||"warn"===e}formatMessage(e){let t=e.timestamp,r=e.level.toUpperCase(),s=e.message,a=e.context?` | Context: ${JSON.stringify(e.context)}`:"",o=e.error?` | Error: ${e.error.message}`:"";return`[${t}] ${r}: ${s}${a}${o}`}addToBuffer(e){this.logBuffer.push(e),this.logBuffer.length>this.maxBufferSize&&this.logBuffer.shift()}async sendToExternalService(e){if(this.isProduction&&"error"===e.level)try{await fetch("/api/logs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(e){console.error("Failed to send log to external service:",e)}}error(e,t,r){let s={level:"error",message:e,timestamp:new Date().toISOString(),context:t,error:r};this.addToBuffer(s),this.shouldLog("error")&&console.error(this.formatMessage(s)),this.sendToExternalService(s)}warn(e,t){let r={level:"warn",message:e,timestamp:new Date().toISOString(),context:t};this.addToBuffer(r),this.shouldLog("warn")&&console.warn(this.formatMessage(r))}info(e,t){let r={level:"info",message:e,timestamp:new Date().toISOString(),context:t};this.addToBuffer(r),this.shouldLog("info")&&console.info(this.formatMessage(r))}debug(e,t){let r={level:"debug",message:e,timestamp:new Date().toISOString(),context:t};this.addToBuffer(r),this.shouldLog("debug")&&console.debug(this.formatMessage(r))}security(e,t){let r={level:"warn",message:`SECURITY: ${e}`,timestamp:new Date().toISOString(),context:t};this.addToBuffer(r),console.warn(this.formatMessage(r)),this.sendToExternalService(r)}performance(e,t,r){let s={level:"info",message:`PERFORMANCE: ${e} took ${t}ms`,timestamp:new Date().toISOString(),context:r};this.addToBuffer(s),this.shouldLog("info")&&console.info(this.formatMessage(s))}getLogs(e){return e?this.logBuffer.filter(t=>t.level===e):[...this.logBuffer]}clearLogs(){this.logBuffer=[]}exportLogs(){return this.logBuffer.map(e=>this.formatMessage(e)).join("\n")}constructor(){this.isDevelopment=!1,this.isProduction=!0,this.logBuffer=[],this.maxBufferSize=100}}let o=new a,i=(e,t,r)=>o.error(e,t,r),n=(e,t)=>o.security(e,t)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[522,753,322],()=>r(4794));module.exports=s})();